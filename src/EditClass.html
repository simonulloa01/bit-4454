<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Student Upload</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet"
        crossorigin="anonymous">
</head>

<body>
    <div class="container mt-5">
        <h1>Student Upload</h1>

        <div class="mb-3">
            <input type="file" id="fileInput" class="form-control" accept=".csv">
        </div>

        <table class="table table-bordered" id="previewTable">
            <thead>
                <tr></tr>
            </thead>
            <tbody></tbody>
        </table>

        <button class="btn btn-primary" id="submitBtn">Submit</button>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"
        crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/papaparse@5.3.0/papaparse.min.js"></script>
    <script>
        const fileInput = document.getElementById('fileInput');
        const previewTable = document.getElementById('previewTable');
        const submitBtn = document.getElementById('submitBtn');

        fileInput.addEventListener('change', handleFileUpload);
        submitBtn.addEventListener('click', handleSubmit);

        let csvData = [];

        function handleFileUpload(event) {
            const file = event.target.files[0];
            if (!file) return;

            Papa.parse(file, {
                complete: function (results) {
                    csvData = results.data;
                    renderTable(csvData);
                },
                header: true
            });
        }

        function renderTable(data) {
            const thead = previewTable.querySelector('thead tr');
            const tbody = previewTable.querySelector('tbody');

            thead.innerHTML = '';
            tbody.innerHTML = '';

            if (data.length === 0) return;

            // Create header
            Object.keys(data[0]).forEach(key => {
                const th = document.createElement('th');
                th.innerText = key;
                thead.appendChild(th);
            });

            // Create body
            data.forEach((row, rowIndex) => {
                const tr = document.createElement('tr');
                Object.values(row).forEach((value, columnIndex) => {
                    const td = document.createElement('td');
                    td.innerText = value;
                    td.contentEditable = true;
                    td.addEventListener('blur', () => handleCellEdit(rowIndex, columnIndex, td.innerText));
                    tr.appendChild(td);
                });
                tbody.appendChild(tr);
            });
        }

        function handleCellEdit(rowIndex, columnIndex, newValue) {
            const key = Object.keys(csvData[0])[columnIndex];
            csvData[rowIndex][key] = newValue;
        }

        function getUrlParameter(name) {
            name = name.replace(/[\[]/, '\\[').replace(/[\]]/, '\\]');
            const regex = new RegExp('[\\?&]' + name + '=([^&#]*)');
            const results = regex.exec(location.search);
            return results === null ? '' : decodeURIComponent(results[1].replace(/\+/g, ' '));
        };

        async function handleSubmit() {
            // Replace 'your-azure-function-url' with your Azure Function URL
            const url = 'http://localhost:7071/api/upload-students';

            // Add session_id and section_id to the payload
            const payload = {
                session_id: getUrlParameter('session_id'), // replace with your session ID
                section_id: getUrlParameter('course_id'), // replace with your section ID
                students: csvData
            };

            try {
                const response = await fetch(url, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(payload)
                });

                const result = await response.text();
                console.log(result);
                alert('Data submitted successfully!');
            } catch (error) {
                1
                console.error('Submission failed', error);
                alert('Submission failed');
            }
        }
    </script>
</body>

</html>